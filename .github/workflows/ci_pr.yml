name: pr_check_generate

on:
  pull_request:
    branches: ['main']

jobs:
  generate_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies ğŸ“¦
        run: bun install

      - name: Generate ğŸ’š
        run: bun generate

      # ç”Ÿæˆç‰©ã‚’é™çš„ã‚µãƒ¼ãƒãƒ¼ã§å…¬é–‹ï¼ˆå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
      - name: Start static server
        run: |
          npx serve -s ./.output/public -l 3000

      - name: Wait for server to be ready
        run: sleep 10

      # Playwrightã‚’ç”¨ã„ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
      - name: Capture screenshot with Playwright
        run: |
          npx playwright install
          npx playwright screenshot http://localhost:3000/clock --output=screenshot.png

      # å–å¾—ã—ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v3
        with:
          name: screenshot
          path: screenshot.png

      # ç”Ÿæˆç‰©ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’èª¿æ•´ï¼‰
      - name: Post screenshot to PR comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const screenshot = fs.readFileSync('screenshot.png', { encoding: 'base64' });
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ç”Ÿæˆç‰©ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ\n![screenshot](data:image/png;base64,${screenshot})`
            });
